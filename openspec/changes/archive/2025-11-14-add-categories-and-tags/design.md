# Design: Categories and Tags Architecture

## Overview

This design introduces a dual taxonomy system for posts using Prisma's implicit many-to-many relations. Categories provide broad content classification, while tags enable granular cross-cutting labeling.

## Data Model Architecture

### Implicit Many-to-Many Relations

We use Prisma's implicit many-to-many pattern because:
- No additional metadata needed on relationships
- Simpler schema definition and queries
- Prisma auto-manages join tables
- Reduces boilerplate code

```prisma
model Post {
  // ... existing fields
  categories Category[]
  tags       Tag[]
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]
  
  @@index([slug])
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  posts     Post[]
  
  @@index([slug])
}
```

**Join Tables (Auto-generated by Prisma):**
- `_CategoryToPost` - Links categories and posts
- `_PostToTag` - Links posts and tags

### Slug Generation Strategy

Both Category and Tag models follow the same slug pattern as Post:
1. Generate base slug from name using existing `slugify` utility
2. Check for duplicates in respective table
3. Append counter (-2, -3, etc.) if duplicate exists
4. Store in database with unique constraint

## API Architecture

### Module Organization

```
apps/api/src/
├── posts/           # Updated for taxonomy support
│   ├── dto/
│   │   ├── create-post.dto.ts   # Add categoryIds[], tagIds[]
│   │   └── update-post.dto.ts   # Add categoryIds[], tagIds[]
│   ├── posts.service.ts         # Handle category/tag associations
│   └── posts.controller.ts      # Add category/tag filters
├── categories/      # New module
│   ├── dto/
│   │   ├── create-category.dto.ts
│   │   └── update-category.dto.ts
│   ├── entities/
│   │   └── category.entity.ts
│   ├── helpers/
│   │   └── slug-generator.helper.ts
│   ├── categories.service.ts
│   ├── categories.controller.ts
│   └── categories.module.ts
└── tags/            # New module
    ├── dto/
    │   ├── create-tag.dto.ts
    │   └── update-tag.dto.ts
    ├── entities/
    │   └── tag.entity.ts
    ├── helpers/
    │   └── slug-generator.helper.ts
    ├── tags.service.ts
    ├── tags.controller.ts
    └── tags.module.ts
```

### Service Layer Patterns

**Creating/Updating Posts with Taxonomy:**
```typescript
// CreatePostDto includes categoryIds and tagIds
await prisma.post.create({
  data: {
    title,
    slug,
    content,
    published,
    authorId,
    categories: {
      connect: categoryIds.map(id => ({ id }))
    },
    tags: {
      connect: tagIds.map(id => ({ id }))
    }
  },
  include: {
    author: { select: { id: true, username: true, email: true } },
    categories: true,
    tags: true
  }
})
```

**Updating Post Taxonomy (Replace Pattern):**
```typescript
await prisma.post.update({
  where: { slug },
  data: {
    // ... other updates
    categories: {
      set: categoryIds.map(id => ({ id }))  // Replaces all
    },
    tags: {
      set: tagIds.map(id => ({ id }))       // Replaces all
    }
  }
})
```

**Filtering Posts by Category/Tag:**
```typescript
// GET /posts?category=news
await prisma.post.findMany({
  where: {
    categories: {
      some: { slug: categorySlug }
    }
  },
  include: { categories: true, tags: true, author: true }
})

// GET /posts?tag=handball
await prisma.post.findMany({
  where: {
    tags: {
      some: { slug: tagSlug }
    }
  },
  include: { categories: true, tags: true, author: true }
})
```

### Response Format

**Post with Taxonomy:**
```json
{
  "id": 1,
  "title": "Welcome Post",
  "slug": "welcome-post",
  "content": "...",
  "published": true,
  "createdAt": "2025-11-14T...",
  "updatedAt": "2025-11-14T...",
  "authorId": 1,
  "author": {
    "id": 1,
    "username": "admin",
    "email": "admin@example.com"
  },
  "categories": [
    {
      "id": 1,
      "name": "News",
      "slug": "news",
      "description": "Latest updates"
    }
  ],
  "tags": [
    {
      "id": 1,
      "name": "handball",
      "slug": "handball"
    },
    {
      "id": 2,
      "name": "youth",
      "slug": "youth"
    }
  ]
}
```

**Category/Tag with Post Count:**
```json
{
  "id": 1,
  "name": "News",
  "slug": "news",
  "description": "Latest updates",
  "createdAt": "2025-11-14T...",
  "updatedAt": "2025-11-14T...",
  "_count": {
    "posts": 15
  }
}
```

## Validation Rules

### Category Validation
- `name`: Required, 1-100 characters, unique
- `description`: Optional, max 500 characters
- `slug`: Auto-generated, unique, indexed

### Tag Validation
- `name`: Required, 1-50 characters, unique
- `slug`: Auto-generated, unique, indexed

### Post Validation
- `categoryIds`: Optional array of integers
- `tagIds`: Optional array of integers
- Validate all IDs exist before creating/updating post

## Error Handling

### Category/Tag Not Found (404)
When creating/updating a post with invalid category/tag IDs:
```json
{
  "message": "Category with ID 999 not found",
  "error": "Not Found",
  "statusCode": 404
}
```

### Delete Constraint (409)
When attempting to delete a category/tag still in use:
```json
{
  "message": "Cannot delete category 'News' - 15 posts still reference it",
  "error": "Conflict",
  "statusCode": 409
}
```

### Duplicate Name (409)
When creating category/tag with existing name:
```json
{
  "message": "Category with name 'News' already exists",
  "error": "Conflict",
  "statusCode": 409
}
```

## Migration Strategy

1. Create migration with `prisma migrate dev --name add-categories-and-tags`
2. Prisma creates Category and Tag tables plus join tables
3. No data migration needed (all new tables start empty)
4. Existing posts unaffected (categories/tags are optional)

## Performance Considerations

- **Indexes:** slug fields indexed for fast lookups
- **Eager Loading:** Use `include` to fetch relations in single query
- **Query Optimization:** Prisma generates efficient JOINs for many-to-many
- **Pagination:** Consider adding pagination to `/posts` endpoint as content grows

## Testing Strategy

- Unit tests for slug generation helpers
- Integration tests for CRUD operations on categories/tags
- E2E tests for post creation with categories/tags
- Test edge cases: empty arrays, non-existent IDs, delete constraints
